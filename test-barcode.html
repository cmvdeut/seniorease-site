<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Scanner Test - SeniorEase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold text-center mb-6">Barcode Scanner Test</h1>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Barcode/ISBN</label>
                <div class="flex gap-2">
                    <input type="text" id="barcodeInput" 
                           placeholder="Scan barcode of voer handmatig in"
                           inputmode="numeric"
                           pattern="[0-9]*"
                           class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <button id="scanBtn" 
                            class="bg-blue-500 text-white px-4 py-3 rounded-lg hover:bg-blue-600 transition-colors">
                        ðŸ“· Scan
                    </button>
                </div>
            </div>
            
            <div id="status" class="text-sm text-gray-600"></div>
            
            <div id="result" class="hidden p-4 bg-green-100 border border-green-400 rounded-lg">
                <h3 class="font-semibold text-green-800">Barcode gevonden!</h3>
                <p id="resultText" class="text-green-700"></p>
            </div>
        </div>
    </div>

    <!-- Scanner Overlay -->
    <div id="scannerOverlay" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden">
        <div class="relative w-full h-full">
            <video id="scannerVideo" class="w-full h-full object-cover"></video>
            
            <!-- Targeting frame -->
            <div class="absolute inset-0 flex items-center justify-center">
                <div class="w-64 h-32 border-2 border-white rounded-lg relative">
                    <div class="absolute top-0 left-0 w-6 h-6 border-t-2 border-l-2 border-green-400"></div>
                    <div class="absolute top-0 right-0 w-6 h-6 border-t-2 border-r-2 border-green-400"></div>
                    <div class="absolute bottom-0 left-0 w-6 h-6 border-b-2 border-l-2 border-green-400"></div>
                    <div class="absolute bottom-0 right-0 w-6 h-6 border-b-2 border-r-2 border-green-400"></div>
                </div>
            </div>
            
            <!-- Instructions -->
            <div class="absolute top-8 left-1/2 transform -translate-x-1/2 text-center text-white">
                <p class="text-lg font-semibold">Scan ISBN of muziek barcode</p>
                <p class="text-sm opacity-80">Richt op de barcode achterop het boek/CD/LP</p>
            </div>
            
            <!-- Controls -->
            <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2">
                <button id="stopBtn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-semibold">
                    Stop scannen
                </button>
            </div>
        </div>
    </div>

    <script>
        let codeReader = null;
        let scannerActive = false;

        function setStatus(message, isError = false) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = isError ? 'text-sm text-red-600' : 'text-sm text-gray-600';
        }

        function showResult(code) {
            const resultEl = document.getElementById('result');
            const resultTextEl = document.getElementById('resultText');
            resultTextEl.textContent = `Gevonden barcode: ${code}`;
            resultEl.classList.remove('hidden');
        }

        async function startScanning() {
            if (scannerActive) return;

            document.getElementById('scannerOverlay').classList.remove('hidden');
            scannerActive = true;
            setStatus('Camera wordt gestart...');

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                setStatus('Camera wordt niet ondersteund door deze browser.', true);
                stopScanning();
                return;
            }

            if (typeof ZXing === 'undefined') {
                setStatus('Barcode scanner wordt niet ondersteund.', true);
                stopScanning();
                return;
            }

            try {
                codeReader = new ZXing.BrowserMultiFormatReader();
                
                codeReader.hints = new Map([
                    [ZXing.DecodeHintType.POSSIBLE_FORMATS, [
                        // ISBN codes (EAN-13 met 978/979 prefix)
                        ZXing.BarcodeFormat.EAN_13,
                        // CD/LP barcodes (meestal EAN-13 of UPC-A)
                        ZXing.BarcodeFormat.UPC_A,
                        ZXing.BarcodeFormat.UPC_E,
                        // Alternatieve formaten voor muziek
                        ZXing.BarcodeFormat.EAN_8,
                        ZXing.BarcodeFormat.CODE_128,
                        ZXing.BarcodeFormat.CODE_39
                    ]],
                    [ZXing.DecodeHintType.TRY_HARDER, true],
                    [ZXing.DecodeHintType.ASSUME_GS1, false]
                ]);

                await codeReader.decodeFromVideoDevice(
                    undefined,
                    document.getElementById('scannerVideo'),
                    (result, err) => {
                        if (result) {
                            console.log('Barcode gevonden:', result.text);
                            const code = result.text;
                            
                            if (code && code.length >= 8) {
                                document.getElementById('barcodeInput').value = code;
                                showResult(code);
                                stopScanning();
                                setStatus('Barcode succesvol gescand!');
                            }
                        }
                        if (err && !(err instanceof ZXing.NotFoundException)) {
                            console.error('Scan error:', err);
                        }
                    },
                    {
                        video: {
                            width: { min: 640, ideal: 1280, max: 1920 },
                            height: { min: 480, ideal: 720, max: 1080 },
                            facingMode: { ideal: "environment" },
                            frameRate: { ideal: 30, max: 60 }
                        }
                    }
                );

                setStatus('Camera actief. Richt op de barcode.');

            } catch (error) {
                console.error('Camera error:', error);
                
                let errorMessage = 'Camera kon niet worden gestart. ';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'Camera toegang is geweigerd.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'Geen camera gevonden.';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage += 'Camera wordt niet ondersteund.';
                } else {
                    errorMessage += error.message;
                }
                
                setStatus(errorMessage, true);
                stopScanning();
            }
        }

        function stopScanning() {
            if (scannerActive) {
                try {
                    if (codeReader) {
                        codeReader.reset();
                        codeReader = null;
                    }
                    scannerActive = false;
                } catch (error) {
                    console.error('Error stopping scanner:', error);
                }
            }
            document.getElementById('scannerOverlay').classList.add('hidden');
            
            const video = document.getElementById('scannerVideo');
            if (video && video.srcObject) {
                const tracks = video.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                video.srcObject = null;
            }
        }

        // Event listeners
        document.getElementById('scanBtn').addEventListener('click', startScanning);
        document.getElementById('stopBtn').addEventListener('click', stopScanning);
        
        // Close scanner when clicking outside
        document.getElementById('scannerOverlay').addEventListener('click', function(e) {
            if (e.target === this) stopScanning();
        });

        // Initialize
        setStatus('Klik op "Scan" om te beginnen');
    </script>
</body>
</html>
